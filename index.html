<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Reservoir Sedimentation Demo üåäüèûÔ∏è</title>
    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2 { color: #1f77b4; }
        #map { height: 500px; margin-top: 20px; }
        .plot-container { margin-top: 30px; }
    </style>
</head>
<body>
    <h1>Reservoir Sedimentation Visualization Demo üåäüèûÔ∏è</h1>

    <!-- 3D Reservoir Surface -->
    <h2>3D Reservoir Sedimentation Over Time (Interactive)</h2>
    <input type="range" id="yearSlider" min="2000" max="2024" value="2000">
    <span id="yearLabel">2000</span>
    <div id="surface3d" class="plot-container" style="height:600px;"></div>

    <!-- Static Metrics -->
    <h2>Sedimentation Metrics</h2>
    <p>Cumulative Loss (%): <span id="cumLoss">0.00</span></p>
    <p>Remaining Volume (%): <span id="remVol">100.00</span></p>

    <!-- 2D Plots -->
    <h2>Cumulative Capacity Loss Over Time</h2>
    <div id="linePlotLoss" class="plot-container" style="height:400px;"></div>

    <h2>Remaining Capacity Over Time</h2>
    <div id="linePlotRemaining" class="plot-container" style="height:400px;"></div>

    <!-- Map -->
    <h2>Reservoir Location Map</h2>
    <div id="map"></div>

    <!-- Table -->
    <h2>Sedimentation Data Table</h2>
    <table border="1" cellpadding="5" cellspacing="0" id="dataTable">
        <thead>
            <tr><th>Year</th><th>Cumulative Loss (%)</th><th>Remaining Capacity (million m¬≥)</th></tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        // ===========================
        // Simulated Reservoir Data
        // ===========================
        const years = Array.from({length: 25}, (_, i) => 2000 + i);
        const sedimentationRate = 0.3;
        const cumulativeLoss = years.map((y, i) => sedimentationRate * i);
        const remainingCapacity = cumulativeLoss.map(cl => 100 - cl);

        const nx = 50, ny = 50;
        const X = Array.from({length: nx}, (_, i) => i * 2);
        const Y = Array.from({length: ny}, (_, i) => i);
        let Z_all_years = [];
        for(let i=0;i<years.length;i++){
            let lossFactor = 1 - sedimentationRate*i/100;
            let Z = [];
            for(let j=0;j<ny;j++){
                let row = [];
                for(let k=0;k<nx;k++){
                    row.push(20*Math.exp(-((k-25)**2 + (j-25)**2)/200)*lossFactor);
                }
                Z.push(row);
            }
            Z_all_years.push(Z);
        }

        // ===========================
        // 3D Surface Plot
        // ===========================
        function update3DSurface(yearIndex){
            const Z = Z_all_years[yearIndex];
            Plotly.newPlot('surface3d', [{
                z: Z,
                x: X,
                y: Y,
                type: 'surface',
                colorscale: 'Viridis'
            }], {
                title: `Reservoir 3D Surface - Year ${years[yearIndex]}`,
                scene: {xaxis:{title:'Width'}, yaxis:{title:'Length'}, zaxis:{title:'Height'}}
            });
            document.getElementById("cumLoss").innerText = cumulativeLoss[yearIndex].toFixed(2);
            document.getElementById("remVol").innerText = remainingCapacity[yearIndex].toFixed(2);
        }

        const slider = document.getElementById("yearSlider");
        const label = document.getElementById("yearLabel");
        slider.addEventListener("input", e => {
            const yearIndex = e.target.value - 2000;
            label.innerText = e.target.value;
            update3DSurface(yearIndex);
        });

        update3DSurface(0); // initial plot

        // ===========================
        // 2D Line Plots
        // ===========================
        Plotly.newPlot('linePlotLoss', [{
            x: years, y: cumulativeLoss,
            type: 'scatter', mode:'lines+markers', marker:{color:'crimson'}
        }], {title:'Cumulative Capacity Loss Over Time', xaxis:{title:'Year'}, yaxis:{title:'Cumulative Loss (%)'}});

        Plotly.newPlot('linePlotRemaining', [{
            x: years, y: remainingCapacity,
            type: 'scatter', mode:'lines+markers', marker:{color:'green'}
        }], {title:'Remaining Capacity Over Time', xaxis:{title:'Year'}, yaxis:{title:'Remaining Capacity (million m¬≥)'}});

        // ===========================
        // Leaflet Map
        // ===========================
        const map = L.map('map').setView([35.0, -120.0], 6);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data ¬© OpenStreetMap contributors'
        }).addTo(map);
        L.circle([35.0, -120.0], {radius: 10000, color:'red', fill:true, fillColor:'orange'}).addTo(map)
            .bindPopup('Demo Reservoir<br>Sed Rate: 0.3%/yr');

        // ===========================
        // Populate Table
        // ===========================
        const tbody = document.querySelector("#dataTable tbody");
        years.forEach((y,i)=>{
            let tr = document.createElement("tr");
            tr.innerHTML = `<td>${y}</td><td>${cumulativeLoss[i].toFixed(2)}</td><td>${remainingCapacity[i].toFixed(2)}</td>`;
            tbody.appendChild(tr);
        });
    </script>
</body>
</html>
