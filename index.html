<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Reservoir Sedimentation Demo</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1, h2 { color: #1f77b4; }
    .plot-container { margin-top: 30px; }
    #map { height: 500px; margin-top: 20px; }
    table { border-collapse: collapse; margin-top: 20px; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #1f77b4; color: white; }
    .metrics span { font-weight: bold; font-size: 1.1em; }

    /* Full-width sliders */
    input[type=range] {
        width: 100%;
        margin: 10px 0;
    }
</style>
</head>
<body>

<h1>Reservoir Sedimentation Visualization Demo</h1>

<h2>3D Reservoir Surface Over Time</h2>
<input type="range" id="yearSlider" min="2000" max="2024" value="2000">
<span id="yearLabel">2000</span>
<div id="surface3d" class="plot-container" style="height:600px;"></div>

<h2>Current Metrics</h2>
<div class="metrics">
    <p>Cumulative Loss (%): <span id="cumLoss">0.00</span></p>
    <p>Remaining Volume (%): <span id="remVol">100.00</span></p>
</div>

<h2>Sedimentation Rate Over Time</h2>
<div id="srPlot" class="plot-container" style="height:400px;"></div>

<h2>Cumulative Capacity Loss Over Time</h2>
<div id="linePlotLoss" class="plot-container" style="height:400px;"></div>

<h2>Remaining Capacity Over Time</h2>
<div id="linePlotRemaining" class="plot-container" style="height:400px;"></div>

<h2>Reservoir Location Map</h2>
<div id="map"></div>

<h2>Sedimentation Data Table</h2>
<table id="dataTable">
    <thead>
        <tr><th>Year</th><th>Cumulative Loss (%)</th><th>Remaining Capacity (million m³)</th><th>Sedimentation Rate (%)</th></tr>
    </thead>
    <tbody></tbody>
</table>

<script>
const years = Array.from({length:25},(_,i)=>2000+i);
const sedimentationRate = 0.3; // % per year
const cumulativeLoss = years.map((y,i)=>sedimentationRate*i);
const remainingCapacity = cumulativeLoss.map(cl=>100-cl);
const srValues = Array.from({length:years.length},()=>sedimentationRate); // constant SR

// 3D reservoir surface
const nx=50, ny=50;
const X = Array.from({length:nx},(_,i)=>i*2);
const Y = Array.from({length:ny},(_,i)=>i);
let Z_all_years=[];
for(let i=0;i<years.length;i++){
    let lossFactor = 1 - sedimentationRate*i/100;
    let Z=[];
    for(let j=0;j<ny;j++){
        let row=[];
        for(let k=0;k<nx;k++){
            row.push(20*Math.exp(-((k-25)**2 + (j-25)**2)/200)*lossFactor);
        }
        Z.push(row);
    }
    Z_all_years.push(Z);
}

function update3DSurface(yearIndex){
    Plotly.newPlot('surface3d',[{
        z: Z_all_years[yearIndex],
        x: X,
        y: Y,
        type:'surface',
        colorscale:'Viridis'
    }],{
        title:`Reservoir 3D Surface - Year ${years[yearIndex]}`,
        scene:{xaxis:{title:'Width'},yaxis:{title:'Length'},zaxis:{title:'Height'}}
    });
    document.getElementById("cumLoss").innerText=cumulativeLoss[yearIndex].toFixed(2);
    document.getElementById("remVol").innerText=remainingCapacity[yearIndex].toFixed(2);
}
update3DSurface(0);
document.getElementById("yearSlider").addEventListener("input",e=>{
    const yearIndex = e.target.value - 2000;
    document.getElementById("yearLabel").innerText = e.target.value;
    update3DSurface(yearIndex);
});

// Line plot for Sedimentation Rate over time
Plotly.newPlot('srPlot',[{
    x: years,
    y: srValues,
    type: 'scatter',
    mode: 'lines+markers',
    marker:{color:'orange'},
    line:{width:2}
}],{
    title:'Sedimentation Rate Over Time',
    xaxis:{title:'Year'},
    yaxis:{title:'Sedimentation Rate (%)'}
});

// Cumulative loss and remaining capacity
Plotly.newPlot('linePlotLoss',[{x:years,y:cumulativeLoss,type:'scatter',mode:'lines+markers',marker:{color:'crimson'}}],
    {title:'Cumulative Capacity Loss Over Time', xaxis:{title:'Year'}, yaxis:{title:'Cumulative Loss (%)'}});

Plotly.newPlot('linePlotRemaining',[{x:years,y:remainingCapacity,type:'scatter',mode:'lines+markers',marker:{color:'green'}}],
    {title:'Remaining Capacity Over Time', xaxis:{title:'Year'}, yaxis:{title:'Remaining Capacity (million m³)'}});

// Map
const map=L.map('map').setView([35.0,-120.0],6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution:'Map data © OpenStreetMap contributors'
}).addTo(map);
L.circle([35.0,-120.0],{radius:10000,color:'red',fill:true,fillColor:'orange'})
    .addTo(map)
    .bindPopup('Demo Reservoir<br>Sed Rate: 0.3%/yr');

// Data table
const tbody = document.querySelector("#dataTable tbody");
years.forEach((y,i)=>{
    let tr=document.createElement("tr");
    tr.innerHTML=`<td>${y}</td><td>${cumulativeLoss[i].toFixed(2)}</td><td>${remainingCapacity[i].toFixed(2)}</td><td>${srValues[i].toFixed(2)}</td>`;
    tbody.appendChild(tr);
});
</script>

</body>
</html>
